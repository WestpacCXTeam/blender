/***************************************************************************************************************************************************************
 *
 * Counter
 *
 **************************************************************************************************************************************************************/


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Dependencies
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
const Custard = require('custardjs');


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Module
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
Blender.counter = (() => {

	return {

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Module init method
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		init: () => {
			Blender.debugging.report(`counter: init`);

			Custard.run( //run this only when no more than 3 blends are currently blending
				[{
					'run': Blender.counter.add,
					'maxCalls': 3,
				}],
				() => {
					Blender.debugging.report(`counter: adding not counting as too many blends are blending`);
				}
			);
		},


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Module add method
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		add: () => {
			Blender.debugging.report(`counter: adding new instance`);

			let counter = 0;

			Fs.readFile( Blender.LOG , (error, data) => { //read the log file
				if( error ) {
					throw error;
				}

				counter = parseInt( data ) + 1; //add this blend

				if(!isNaN( counter )) { //check if the number is a number
					Fs.writeFile( Blender.LOG, counter, (error) => {
						if( error ) {
							throw error;
						}

						Blender.debugging.report(`counter: added`);
						Custard.finished();
					});
				}
				else { //throw error
					Blender.log.error(`             Counter number not valid ("${counter}"). Leaving it alone for now!`);
				}
			});
		},

	}

})();